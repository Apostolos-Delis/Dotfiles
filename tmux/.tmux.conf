# =============================================================================
# TERMINAL SETTINGS
# =============================================================================

# Use default shell (no longer need reattach-to-user-namespace since tmux 2.6)
set -g default-command "$SHELL"

# Enable 256 colors and true color (24-bit)
set -g default-terminal "tmux-256color"
set -as terminal-overrides ',xterm*:Tc:sitm=\E[3m'

# Undercurl support (for Neovim LSP diagnostics)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Extended keys and passthrough for modern terminal features
set -g allow-passthrough on
set -g extended-keys on
set -as terminal-features 'xterm*:extkeys,tmux*:extkeys'

# Pass through Shift+Enter (ESC + newline) to applications like Claude Code
set -s user-keys[0] "\e\n"
bind-key -n User0 send-keys "\e\n"

# Scrollback buffer
set -g history-limit 20000

# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Use C-a as prefix (easier than C-b)
set-option -g prefix C-a
unbind-key C-b
bind-key C-a send-prefix

# Start window and pane numbering at 1
set -g base-index 1
set -g pane-base-index 1

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Make Escape time fast (important for Vim)
set -sg escape-time 0

# Send focus events to applications (helps with cursor visibility)
set -g focus-events on

# Allow arrow keys immediately after changing windows
set-option -g repeat-time 0

# Vi mode for copy mode
setw -g mode-keys vi

# Mouse support
set -g mouse on

# =============================================================================
# KEY BINDINGS
# =============================================================================

# Easy config reload
bind-key R source-file ~/.tmux.conf \; display-message "tmux.conf reloaded."

# Command prompt and refresh
bind-key : command-prompt
bind-key r refresh-client
bind-key L clear-history

# Window navigation
bind-key space next-window
bind-key bspace previous-window
bind-key enter next-layout
bind-key c new-window -c "#{pane_current_path}"
bind-key t next-window
bind-key T previous-window

# Vim-like splits (keep current path)
bind-key v split-window -h -c "#{pane_current_path}"
bind-key s split-window -v -c "#{pane_current_path}"

# Pane resizing
bind-key j resize-pane -D 5
bind-key k resize-pane -U 5
bind-key h resize-pane -L 5
bind-key l resize-pane -R 5

# Pane management
bind-key x kill-pane
bind-key a last-pane
bind-key q display-panes
bind-key C-o rotate-window
bind-key [ swap-pane -U
bind-key ] swap-pane -D

# Layouts
bind-key + select-layout main-horizontal
bind-key = select-layout main-vertical
set-window-option -g other-pane-height 25
set-window-option -g other-pane-width 80

# Reorder windows with Ctrl+Shift+Arrow
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1

# Send C-l to clear screen (since C-l is used for pane nav)
bind C-l send-keys 'C-l'

# Synchronize panes toggle (useful for multi-server commands)
bind S setw synchronize-panes

# Session management
bind C-c new-session
bind C-f command-prompt -p find-session 'switch-client -t %%'

# =============================================================================
# COPY MODE (Vi-style)
# =============================================================================

# Enter copy mode with prefix+[
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# =============================================================================
# VIM-TMUX NAVIGATOR
# Smart pane switching with awareness of Vim splits
# =============================================================================

is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'
bind-key -n 'C-\' if-shell "$is_vim" 'send-keys C-\\' 'select-pane -l'

# Also bind in copy-mode-vi
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# =============================================================================
# STATUS BAR - Atom One Dark palette
# bg: #282c34, fg: #abb2bf, comment: #5c6370
# red: #e06c75, green: #98c379, yellow: #e5c07b
# blue: #61afef, magenta: #c678dd, cyan: #56b6c2
# =============================================================================

set-option -g status-interval 1
set-option -g status-left ''
set-option -g status-right '#[fg=#5c6370]%l:%M%p'
set-option -g status-style 'bg=#282c34,fg=#abb2bf'

# Window status (tab) styling
set-option -g window-status-format '#[fg=#5c6370] #I:#W '
set-option -g window-status-current-format '#[fg=#56b6c2,bold] #I:#W '

# Pane borders
set-option -g pane-border-style 'fg=#3e4452'
set-option -g pane-active-border-style 'fg=#56b6c2'

# Display pane numbers longer
set-window-option -g display-panes-time 2000

# Window activity notifications
setw -g monitor-activity on
set -g visual-activity on

# =============================================================================
# PLUGINS (via TPM - Tmux Plugin Manager)
# Install: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Then press prefix + I to install plugins
# =============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# tmux-resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# tmux-continuum settings (auto-save every 15 min, auto-restore on start)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Initialize TPM (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
